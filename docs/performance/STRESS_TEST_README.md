# 压力测试说明

## 测试概述

压力测试用于验证系统在高并发场景下的表现，特别是1000人同时选座的情况。

**测试日期**: 2025-01-17  
**测试框架**: JUnit 5, Spring Boot Test, MockMvc  
**测试场景**: 1000人同时选座（同一座位 / 不同座位 / 多用户同一座位 / 多用户不同座位）  

---

## 1. 测试类说明

### 1.1 StressTest - 压力测试类

**位置**: `src/test/java/com/example/backend/controller/StressTest.java`

**测试方法**:

1. **`testStressSelectSeatSameSeat()`**
   - **场景**: 1000人同时选择同一个座位（单用户多次请求）
   - **目标**: 测试座位冲突检测在高并发场景下的表现
   - **预期**: 只有1个用户成功选座，其他999个用户检测到座位冲突

2. **`testStressSelectSeatDifferentSeats()`**
   - **场景**: 1000人同时选择不同的座位（单用户多次请求）
   - **目标**: 测试系统在高并发场景下的吞吐量
   - **预期**: 大部分用户成功选座，成功率 ≥ 95%

3. **`testStressSelectSeatMultipleUsersSameSeat()`** ⭐ **新增**
   - **场景**: 1000个不同用户同时选择同一个座位（多用户并发）
   - **目标**: 测试多用户场景下座位冲突检测的表现
   - **预期**: 只有1个用户成功选座，其他999个用户检测到座位冲突
   - **特点**: 每个用户先登录获取独立token，然后进行选座操作

4. **`testStressSelectSeatMultipleUsersDifferentSeats()`** ⭐ **新增**
   - **场景**: 1000个不同用户同时选择不同的座位（多用户并发）
   - **目标**: 测试多用户并发场景下系统的吞吐量
   - **预期**: 大部分用户成功选座，成功率 ≥ 95%
   - **特点**: 每个用户先登录获取独立token，然后选择不同座位进行选座操作

### 1.2 SeatOrderConcurrentTest - 并发测试类（包含压力测试）

**位置**: `src/test/java/com/example/backend/controller/SeatOrderConcurrentTest.java`

**测试方法**:

1. **`testStressSelectSeat1000Users()`**
   - **场景**: 1000人同时选择同一个座位
   - **目标**: 测试座位冲突检测
   - **预期**: 只有1个用户成功选座

---

## 2. 测试配置

### 2.1 基本配置

| 参数 | 数值 |
|------|------|
| 并发用户数 | 1000 |
| 超时时间 | 10 分钟 |
| 测试账号 | diy4869@gmail.com / 123456 |

### 2.2 测试数据

| 参数 | 数值 |
|------|------|
| 电影场次ID | TEST_MOVIE_SHOW_TIME_ID |
| 影厅ID | TEST_THEATER_HALL_ID |
| 测试座位（同一座位） | (5, 5) |
| 测试座位（不同座位） | (10+userId, 10+userId) |
| 测试账号 | diy4869@gmail.com / 123456 |

### 2.3 测试场景说明

#### 场景1 & 2：单用户压力测试
- **特点**: 使用同一个token，模拟单个用户多次并发请求
- **适用**: 测试系统对同一用户高并发请求的处理能力

#### 场景3 & 4：多用户压力测试 ⭐ **新增**
- **特点**: 每个用户先登录获取独立token，然后进行选座操作
- **适用**: 测试系统对不同用户并发请求的处理能力和冲突检测准确性
- **更贴近真实场景**: 模拟真实的多用户并发选座场景

---

## 3. 运行压力测试

### 3.1 运行所有压力测试

```bash
cd java-backend

# 运行所有压力测试
./mvnw test -Dtest=StressTest

# 运行特定压力测试
./mvnw test -Dtest=StressTest#testStressSelectSeatSameSeat
./mvnw test -Dtest=StressTest#testStressSelectSeatDifferentSeats

# 运行多用户压力测试（新增）
./mvnw test -Dtest=StressTest#testStressSelectSeatMultipleUsersSameSeat
./mvnw test -Dtest=StressTest#testStressSelectSeatMultipleUsersDifferentSeats
```

### 3.2 运行并发测试中的压力测试

```bash
# 运行1000人同时选座测试
./mvnw test -Dtest=SeatOrderConcurrentTest#testStressSelectSeat1000Users
```

### 3.3 注意事项

1. **测试时间**: 
   - 单用户压力测试：可能需要 5-10 分钟
   - **多用户压力测试**：可能需要 **15-20 分钟**（因为每个用户都需要先登录）
2. **系统资源**: 确保测试环境有足够的CPU和内存资源
3. **数据库连接**: 确保数据库连接池配置足够大（建议 ≥ 100）
4. **测试数据**: 确保测试数据存在且可用
5. **多用户测试**: 多用户压力测试会先进行登录操作，会增加总测试时间，但更贴近真实场景

---

## 4. 测试结果分析

### 4.1 关键指标

| 指标 | 说明 | 评价标准 |
|------|------|---------|
| 成功选座数 | 成功选座的用户数 | 同一座位场景：应为1；不同座位场景：≥ 95% |
| 冲突检测数 | 检测到座位冲突的用户数 | 同一座位场景：≥ 999 |
| 错误请求数 | 发生错误的请求数 | ≤ 5% |
| 吞吐量 | 请求/秒 | 越高越好 |
| 响应时间 | 平均/P50/P95/P99 | P99 < 5000ms |
| 冲突检测率 | 冲突检测准确率 | ≥ 99% |

### 4.2 性能指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 吞吐量 | ≥ 50 请求/秒 | 系统处理能力 |
| 平均响应时间 | < 1000ms | 用户体验 |
| P95响应时间 | < 3000ms | 95%用户的响应时间 |
| P99响应时间 | < 5000ms | 99%用户的响应时间 |
| 错误率 | < 5% | 系统稳定性 |

---

## 5. 测试报告

### 5.1 控制台输出

压力测试会在控制台输出详细的测试结果，包括：

- 测试进度
- 请求结果统计
- 性能指标（吞吐量、响应时间等）
- 错误列表
- 测试结论

### 5.2 测试报告文档

详细的测试结果请参考：
- [并发测试报告](./CONCURRENT_TEST_REPORT.md)
- [选座测试报告](./SEAT_SELECTION_TEST_REPORT.md)

---

## 6. 故障排查

### 6.1 常见问题

**问题1**: 测试超时

**可能原因**:
- 系统资源不足
- 数据库连接池过小
- 网络延迟

**解决方案**:
- 增加测试超时时间
- 增加数据库连接池大小
- 检查网络连接

**问题2**: 错误率过高

**可能原因**:
- 系统负载过高
- 数据库性能瓶颈
- 代码bug

**解决方案**:
- 检查系统资源使用情况
- 优化数据库查询
- 检查代码逻辑

**问题3**: 冲突检测不准确

**可能原因**:
- 并发控制机制有问题
- 数据库事务隔离级别不当
- 缺少分布式锁

**解决方案**:
- 检查并发控制代码
- 调整事务隔离级别
- 实现分布式锁

---

## 7. 测试环境配置

### 7.1 数据库配置

```yaml
# application.yml
spring:
  datasource:
    hikari:
      maximum-pool-size: 100  # 增加连接池大小
      minimum-idle: 50
      connection-timeout: 30000
```

### 7.2 JVM参数

```bash
# 运行测试时指定JVM参数
./mvnw test -Dtest=StressTest -DargLine="-Xmx4096m -Xms2048m"
```

### 7.3 系统资源

| 资源 | 推荐配置 |
|------|---------|
| CPU | ≥ 4核 |
| 内存 | ≥ 8GB |
| 数据库连接池 | ≥ 100 |

---

## 8. 持续改进

### 8.1 定期执行压力测试

- 每周执行一次压力测试
- 代码变更后执行压力测试
- 系统配置变更后执行压力测试

### 8.2 监控测试结果

- 跟踪性能指标变化
- 识别性能瓶颈
- 制定优化计划

### 8.3 优化系统性能

根据测试结果优化系统：
- 优化数据库查询
- 增加缓存
- 优化并发控制
- 扩容系统资源

---

## 9. 相关文档

- [并发测试报告](./CONCURRENT_TEST_REPORT.md)
- [选座测试报告](./SEAT_SELECTION_TEST_REPORT.md)
- [改善建议文档](./IMPROVEMENTS_RECOMMENDATIONS.md)
- [测试覆盖率报告](./COVERAGE_TEST_REPORT.md)

---

**文档生成时间**: 2025-01-17  
**文档版本**: v1.0  
**维护状态**: 持续更新
