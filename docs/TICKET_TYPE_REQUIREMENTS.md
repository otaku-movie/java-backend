# 票种需求与设计说明

本文档整理「票种」相关需求与设计结论，便于后续实现与评审。仅描述产品与数据逻辑，不涉及具体接口与代码。

---

## 1. 票种归属：按影院

- **结论**：票种由**影院**维度维护，不同影院可以有不同的票种配置。
- **含义**：
  - 每个影院拥有自己的票种列表（名称、价格、描述、启用状态、适用规则等）。
  - 同一院线下的不同影院可以配置不同票种。
- **与现有数据**：当前 `movie_ticket_type` 已有 `cinema_id`，可继续沿用「票种归属影院」的模型。

---

## 2. 适用日期：在规则上增加「星期几」，可多选

- **结论**：不在票种数量上膨胀（如为周二/周三各建一套票种），而是在**规则**上增加「适用日期」。
- **实现方式**：
  - 适用日期按**星期几**表达，支持多选（如勾选「火」「水」表示周二、周三生效）。
  - 不勾选或全选的具体含义由业务约定（例如表示「全周」）。
- **效果**：同一票种「一般」在平时用默认价，在周二/周三可走「适用日期=周二、周三」的规则价。

---

## 3. 添加场次时：默认规则只展示「当天符合」的票种

- **结论**：在**添加/发布场次**界面，使用默认规则时，只展示**当前操作日期（或场次放映日期）符合适用日期**的票种。
- **逻辑**：
  - 根据「当前日期」或「场次放映日期」得到星期几；
  - 过滤出「适用星期几」包含该日的票种；
  - 仅展示这些票种，避免出现「当天本不该出现」的选项。
- **目的**：界面简洁、逻辑清晰，避免误选无效票种。

---

## 4. 票种类型：周 / 月等

- **结论**：为票种增加「类型」字段，用于区分生效周期是「按周」还是「按月」等。
- **类型含义（建议）**：

| 类型 | 含义 | 适用日期配置方式 |
|------|------|------------------|
| **周** | 按星期几生效 | 勾选 月～日（可多选），如只勾「水」= 每周三 |
| **月** | 按「每月」规则生效 | 如：每月第 N 个星期几、每月几号等（具体规则可后续细化） |

- **与展示/过滤的关系**：
  - **周**：添加场次或选座时，用「当天是星期几」过滤展示。
  - **月**：用「当天日期」判断是否落在月规则内，再决定是否展示（月规则细节确定后再实现）。

类型用票种专用字典 `ticket_type_schedule_type` 维护：**周、月、每日、特定日期**（1/2/3/4）。

- **已实现**：票种「生效周期」**在票种表单内直接配置**，不关联那边的规则（活动/定价规则暂不管）。
  - **周**：本表单勾选「适用星期几」即可。
  - **月 / 每日 / 特定日期**：字典已支持，月（每月几号等）、特定日期（具体日期）的配置项可后续在表单内加；规则侧不选、不联动。
- 字典扩展见 `add_ticket_type_schedule_fields.sql`（周、月）与 `add_ticket_type_schedule_type_daily_specific.sql`（每日、特定日期）。若曾把 schedule_type 改成规则类型，可执行 `revert_schedule_type_to_ticket_type.sql` 还原。

---

## 5. 组合票与复杂条件：不追求全字典，算价用类型

- **现象**：票种除简单「单人+价格」外，还有组合/条件类，例如：
  - ペア割（双人优惠）；
  - 双人票且其中 1 人需满一定年龄。
- **结论**：
  - 这类业务**不追求全部用字典穷举**，名称与条件可用自由描述或少量扩展字段表达。
  - **存字典/类型的目的是便于计算价格**：即有一层「可枚举的计费类型」，对应明确的计算规则（单人价、双人价、是否校验人数/年龄等）。
- **建议拆分**：
  - **计费层**：用「票种计费类型」或字典驱动算价逻辑（如：单人标准价、双人组合价、双人且一人满龄等），保证程序可计算。
  - **展示层**：名称、描述、组合条件等可自由配置，不必全部进字典。

---

## 6. 启用/禁用

- **结论**：票种需要支持**启用/禁用**，以便在不删除数据的前提下控制某票种是否在选座/购票中展示与可用。
- **粒度**：按当前结论为「按影院」的票种，启用/禁用即针对该影院下该票种；若后续有「院线级」配置再单独扩展。

---

## 7. 特别票价：固定价 + 特定人群不同价

- **场景**：某类特别票价（如周三服务日）下，既有**统一固定价**（如一般 1,400円），又希望**特定人群**在该日享受不同价格（如大学生 1,100円、シニア 1,100円）。
- **结论**：不按「一个特别日 = 一个价格」来做，而是按「**一条规则 = 适用日期 + 多档价格（按人群/票种）**」。
- **做法建议**：
  - 同一条规则（或同一「特别定价」配置）上：
    - 绑定**适用日期**（如仅周三）；
    - 绑定**多条价格**，每条对应一个**人群或票种**：如「一般 → 1,400」「大学生 → 1,100」「シニア → 1,100」等。
  - 固定价 = 默认/一般对应的那一档；特定人群价 = 该规则下该人群/票种对应的那一档。
- **算价逻辑**：用户选场次日期 + 选票种 → 先筛出「该日期适用」的规则 → 在该规则下取「该票种/人群」对应的价格；若规则未配置该人群则回退到票种默认价或上一条规则。
- **与现有规则的关系**：若现有活动/定价规则已支持「一条规则下按 audience_type 或票种配置多档价格」，则只需在规则上增加「适用星期几」等日期条件即可覆盖本场景；若目前是「一条规则一个价」，则需扩展为「一条规则多档价（按人群/票种）」。
- **适用范围：特定场次**：特别票价**仅适用于特定场次**，不因「当天是周三」就自动作用于该日全部场次。即需要在**场次**维度上关联或标记「本场次是否使用某条特别定价规则」；只有被标记的场次才按该规则的多档价售卖，其余场次仍按默认规则或票种默认价。配置方式可以是：发布/编辑场次时选择「适用特别定价规则」，或场次表存 rule_id/special_price_id 等关联。

---

## 8. 与现有定价体系的关系

- 现有已有**活动、定价规则**（月度/周度/固定日/时段/固定票价/票种规则等）。
- 本需求中：
  - **适用日期（星期几）**建议挂在现有规则上，或作为规则筛选条件，不重复造一套「日期引擎」；
  - **票种类型（周/月）**仅表示该票种的「生效周期维度」，与规则中的日期判断配合使用。
- **特别票价多档价**：见第 7 节，一条规则支持「适用日期 + 多个人群/票种对应不同价格」，以覆盖「固定价 + 特定人群别的价」的场景。

---

## 9. 小结表

| 项 | 结论 |
|----|------|
| 票种归属 | 按**影院**，不同影院可配置不同票种 |
| 适用日期 | 规则上增加「星期几」多选，不靠复制票种做周二/周三 |
| 添加场次默认规则 | 只展示「当前/场次日期」符合适用日期的票种 |
| 票种类型 | 增加类型：**周**（按星期几）、**月**（按每月规则），可字典化 |
| 组合/复杂票种 | 不追求全字典；用「计费类型」驱动算价，名称/条件自由或扩展字段 |
| 启用/禁用 | 票种支持启用/禁用，便于控制是否展示与可售 |
| 特别票价多档价 | 一条规则 = 适用日期 + 多档价格（按人群/票种）；固定价与特定人群价同属一条规则 |
| 特别票价适用范围 | **仅适用于特定场次**：在场次上关联/标记使用的特别定价规则，不按日期自动应用到当日全部场次 |

---

*文档版本：初稿，随需求讨论可增补或修订。*
