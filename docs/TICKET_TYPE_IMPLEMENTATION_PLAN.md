# 票种需求实现计划

基于 `TICKET_TYPE_REQUIREMENTS.md` 的分阶段实现计划，便于按阶段上线看效果。

---

## 阶段一：票种基础（启用/禁用、类型、适用星期几）

**目标**：票种支持启用/禁用、类型（周/月）、适用星期几；添加场次或选座时只展示「当天符合」的票种。

| 步骤 | 内容 |
|------|------|
| 1.1 数据库 | `movie_ticket_type` 增加：`enabled`（启用，默认 true）、`schedule_type`（字典 code，周/月）、`applicable_weekdays`（适用星期几，如 1–7 多选，存 JSON 或逗号分隔）；字典表增加 `ticket_type_schedule_type`（周=1, 月=2） |
| 1.2 后端实体与接口 | 实体字段；票种列表接口支持按 `cinemaId` + `weekday`（或 `date`）过滤，只返回 enabled 且当天适用的票种；影院保存/票种保存时写入新字段 |
| 1.3 管理后台 | 影院详情-票种编辑：每票种增加「启用」开关、「类型」下拉、「适用星期几」多选；展示时可根据日期预览「当日适用」 |
| 1.4 添加场次 | 发布场次若某处依赖票种列表（或后续选座）：调用票种接口时传入场次放映日期的星期几，只展示符合的票种 |
| 1.5 选座/购票 | 选座或购票拉取票种列表时，传入场次日期，后端按 weekday 过滤后返回 |

**交付**：票种可配置启用/类型/星期几，列表与选座按日期过滤，先看效果再进入阶段二。

---

## 阶段二：规则适用日期（星期几）

**目标**：现有定价/活动规则增加「适用星期几」多选；算价时仅在该日期适用时生效。

| 步骤 | 内容 |
|------|------|
| 2.1 数据库 | 规则相关表（如 `pricing_rule`、`promotion_weekly_day` 或活动配置）增加「适用星期几」字段或子表 |
| 2.2 后端 | 规则匹配/算价时，先根据场次日期得到 weekday，再过滤「适用星期几」包含该日的规则 |
| 2.3 管理后台 | 活动/规则编辑页增加「适用星期几」多选 |

**交付**：周二/周三等「按星期几」的规则生效，与阶段一票种过滤一致。

---

## 阶段三：特别票价（多档价 + 场次关联）

**目标**：支持「一条规则 = 适用日期 + 多档价格（按人群/票种）」；特别票价仅对「关联了该规则的场次」生效。

| 步骤 | 内容 |
|------|------|
| 3.1 数据与模型 | 特别定价规则表或扩展现有规则：适用星期几 + 多条「人群/票种 → 价格」；`movie_show_time` 增加 `special_price_rule_id`（或等价）关联 |
| 3.2 后端算价 | 若场次有关联特别规则且日期匹配，则按该规则的多档价取价；否则走原有规则/票种默认价 |
| 3.3 管理后台 | 特别定价规则维护（多档价配置）；发布/编辑场次时可选「适用特别定价规则」 |

**交付**：特定场次可挂特别规则，多档价按人群/票种生效。

---

## 阶段四（可选）：组合票与计费类型

**目标**：票种计费类型（单人/双人组合等）、扩展字段或描述，驱动算价与展示。可放在阶段一～三稳定后再做。

---

## 票种生效周期（已按「直接在这里实现」）

**结论**：票种「生效周期」在票种表单内直接配置，不关联规则。字典 `ticket_type_schedule_type`：周(1)、月(2)、每日(3)、特定日期(4)。周 = 本表单「适用星期几」；月/每日/特定日期的具体配置可后续在表单内扩展，规则侧暂不联动。

---

## 当前先做：阶段一

先实现阶段一，上线后根据效果再推进阶段二、三。阶段一具体任务见下方 Todo，按顺序实现即可。
