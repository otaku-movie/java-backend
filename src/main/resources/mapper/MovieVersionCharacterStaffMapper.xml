<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.example.backend.mapper.MovieVersionCharacterStaffMapper">
    
    <!-- 结果映射 -->
    <resultMap id="CharacterResponseMap" type="com.example.backend.response.CharacterResponse">
        <id property="id" column="character_id"/>
        <result property="name" column="character_name"/>
        <result property="originalName" column="character_original_name"/>
        <result property="cover" column="character_cover"/>
        <result property="description" column="character_description"/>
        <collection property="staff" ofType="com.example.backend.response.Staff">
            <id property="id" column="staff_id"/>
            <result property="name" column="staff_name"/>
            <result property="cover" column="staff_cover"/>
        </collection>
    </resultMap>
    
    <!-- 获取指定版本的角色列表及其配音演员 -->
    <select id="getVersionCharacters" resultMap="CharacterResponseMap">
        SELECT
            c.id AS character_id,
            c.name AS character_name,
            c.original_name AS character_original_name,
            c.cover AS character_cover,
            c.description AS character_description,
            s.id AS staff_id,
            s.name AS staff_name,
            s.cover AS staff_cover
        FROM
            movie_version_character mvc
        LEFT JOIN
            "character" c ON mvc.character_id = c.id
        LEFT JOIN
            movie_version_character_staff mvcs ON mvc.movie_version_id = mvcs.movie_version_id AND mvc.character_id = mvcs.character_id
        LEFT JOIN
            staff s ON mvcs.staff_id = s.id
        WHERE
            mvc.movie_version_id = #{movieVersionId}
            AND mvc.deleted::integer = 0
            AND (mvcs.deleted::integer = 0 OR mvcs.deleted IS NULL)
        ORDER BY
            c.id, s.id
    </select>
    
</mapper>
